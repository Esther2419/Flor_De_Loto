generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model categorias {
  id                       BigInt       @id @default(autoincrement())
  nombre                   String       @db.VarChar(100)
  descripcion              String?
  foto                     String?
  portada                  String?
  fecha_creacion           DateTime?    @default(now()) @db.Timestamp(6)
  fecha_actualizacion      DateTime?    @db.Timestamp(6)
  usuario_actualizacion_id BigInt?
  categoria_padre_id       BigInt?
  usuarios                 usuarios?    @relation(fields: [usuario_actualizacion_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_cat_audit")
  categorias               categorias?  @relation("categoriasTocategorias", fields: [categoria_padre_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_cat_padre")
  other_categorias         categorias[] @relation("categoriasTocategorias")
  ramos                    ramos[]
}

model flores {
  id                       BigInt                @id @default(autoincrement())
  nombre                   String                @db.VarChar(100)
  descripcion              String?
  color                    String?               @db.VarChar(50)
  foto                     String?
  precio_unitario          Decimal               @db.Decimal(10, 2)
  disponible               Boolean?              @default(true)
  cantidad                 Int                   @default(0)
  fecha_creacion           DateTime?             @default(now()) @db.Timestamp(6)
  fecha_actualizacion      DateTime?             @db.Timestamp(6)
  usuario_actualizacion_id BigInt?
  usuarios                 usuarios?             @relation(fields: [usuario_actualizacion_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_flor_audit")
  ramo_detalle             ramo_detalle[]
  reserva_adicionales      reserva_adicionales[]
}

model envolturas {
  id                       BigInt            @id @default(autoincrement())
  nombre                   String            @db.VarChar(100)
  color                    String?           @db.VarChar(50)
  diseno                   String?           @db.VarChar(100)
  foto                     String?
  precio_unitario          Decimal           @default(0) @db.Decimal(10, 2)
  disponible               Boolean?          @default(true)
  cantidad                 Int               @default(0)
  fecha_creacion           DateTime?         @default(now()) @db.Timestamp(6)
  fecha_actualizacion      DateTime?         @db.Timestamp(6)
  usuario_actualizacion_id BigInt?
  usuarios                 usuarios?         @relation(fields: [usuario_actualizacion_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_envoltura_audit")
  ramo_envolturas          ramo_envolturas[] // RELACIÓN MUCHOS A MUCHOS
  reservas                 reservas[]
}

// --- NUEVA TABLA INTERMEDIA PARA MUCHAS ENVOLTURAS ---
model ramo_envolturas {
  id           BigInt     @id @default(autoincrement())
  ramo_id      BigInt
  envoltura_id BigInt
  cantidad     Int?       @default(1)
  ramos        ramos      @relation(fields: [ramo_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_ramo_env")
  envolturas   envolturas @relation(fields: [envoltura_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_env_det")
}

model ramo_detalle {
  id            BigInt @id @default(autoincrement())
  ramo_id       BigInt
  flor_id       BigInt
  cantidad_base Int?   @default(1)
  flores        flores @relation(fields: [flor_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_flor_det")
  ramos         ramos  @relation(fields: [ramo_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_ramo_det")
}

model ramo_imagenes {
  id       BigInt @id @default(autoincrement())
  ramo_id  BigInt
  url_foto String
  ramos    ramos  @relation(fields: [ramo_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_ramo_img")
}

model ramos {
  id                       BigInt            @id @default(autoincrement())
  nombre                   String            @db.VarChar(150)
  descripcion              String?
  precio_base              Decimal           @db.Decimal(10, 2)
  categoria_id             BigInt?
  activo                   Boolean?          @default(true)
  fecha_creacion           DateTime?         @default(now()) @db.Timestamp(6)
  fecha_actualizacion      DateTime?         @db.Timestamp(6)
  usuario_actualizacion_id BigInt?
  tipo                     String?           @db.VarChar
  es_oferta                Boolean?          @default(false)
  precio_oferta            Decimal?          @db.Decimal(10, 2)
  foto_principal           String?
  ramo_detalle             ramo_detalle[]
  ramo_imagenes            ramo_imagenes[]
  ramo_envolturas          ramo_envolturas[] // RELACIÓN MUCHOS A MUCHOS
  categorias               categorias?       @relation(fields: [categoria_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_categoria")
  usuarios                 usuarios?         @relation(fields: [usuario_actualizacion_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_ramo_audit")
  reservas                 reservas[]
}

model reserva_adicionales {
  id                BigInt   @id @default(autoincrement())
  reserva_id        BigInt
  flor_id           BigInt
  cantidad          Int
  precio_al_momento Decimal? @db.Decimal(10, 2)
  tipo_entrega      String?  @default("integrado") @db.VarChar(20)
  flores            flores   @relation(fields: [flor_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_flor_adic")
  reservas          reservas @relation(fields: [reserva_id], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "fk_reserva_adic")
}

model reservas {
  id                                               BigInt                @id @default(autoincrement())
  usuario_id                                       BigInt?
  nombre_contacto                                  String                @db.VarChar(150)
  telefono_contacto                                String                @db.VarChar(20)
  correo_contacto                                  String?               @db.VarChar(150)
  ramo_catalogo_id                                 BigInt?
  es_personalizado                                 Boolean?              @default(false)
  foto_referencia_cliente                          String?
  descripcion_solicitud                            String?
  envoltura_elegida_id                             BigInt?
  precio_envoltura_momento                         Decimal?              @db.Decimal(10, 2)
  fecha_solicitud                                  DateTime?             @default(now()) @db.Timestamp(6)
  fecha_entrega                                    DateTime              @db.Date
  mensaje_dedicatoria                              String?
  direccion_entrega                                String?
  estado                                           String?               @default("pendiente") @db.VarChar(20)
  precio_final                                     Decimal?              @db.Decimal(10, 2)
  fecha_actualizacion                              DateTime?             @db.Timestamp(6)
  usuario_actualizacion_id                         BigInt?
  reserva_adicionales                              reserva_adicionales[]
  ramos                                            ramos?                @relation(fields: [ramo_catalogo_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_ramo_reserva")
  usuarios_reservas_usuario_actualizacion_idTousuarios usuarios?         @relation("reservas_usuario_actualizacion_idTousuarios", fields: [usuario_actualizacion_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_reserva_audit")
  envolturas                                       envolturas?           @relation(fields: [envoltura_elegida_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_reserva_envoltura")
  usuarios_reservas_usuario_idTousuarios           usuarios?             @relation("reservas_usuario_idTousuarios", fields: [usuario_id], references: [id], onDelete: NoAction, onUpdate: NoAction, map: "fk_usuario_reserva")
}

model usuarios {
  id                                                   BigInt       @id @default(autoincrement())
  nombre_completo                                      String       @db.VarChar(150)
  email                                                String       @unique @db.VarChar(150)
  password                                             String       @db.VarChar(255)
  celular                                              String?      @db.VarChar(20)
  rol                                                  String?      @default("cliente") @db.VarChar(20)
  foto                                                 String?
  activo                                               Boolean?     @default(true)
  fecha_registro                                       DateTime?    @default(now()) @db.Timestamp(6)
  categorias                                           categorias[]
  envolturas                                           envolturas[]
  flores                                               flores[]
  ramos                                                ramos[]
  reservas_reservas_usuario_actualizacion_idTousuarios reservas[]   @relation("reservas_usuario_actualizacion_idTousuarios")
  reservas_reservas_usuario_idTousuarios               reservas[]   @relation("reservas_usuario_idTousuarios")
}